---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BoardCard from '../components/BoardCard.astro';
import GalleryItem from '../components/GalleryItem.astro';
import { getCollection } from 'astro:content';

const privateWork = (await getCollection('private')).sort((a, b) => a.data.order - b.data.order);
const privateDrawings = (await getCollection('private-drawings')).sort((a, b) => a.data.order - b.data.order);

const projects = [...new Set(privateDrawings.map(d => d.data.project))];
---

<BaseLayout title="Sarrah Campbell â€” Private Work">
  <!-- Password gate -->
  <div id="password-gate" class="password-gate">
    <div class="password-box">
      <h2 class="heading">Client Work</h2>
      <p>Enter the password to view this content.</p>
      <form id="password-form">
        <input type="password" id="password-input" placeholder="Password" autocomplete="off" required />
        <button type="submit" class="btn btn-primary">Enter</button>
      </form>
      <p id="password-error" class="error" hidden>Incorrect password. Please try again.</p>
      <a href={import.meta.env.BASE_URL} class="back-link">&larr; Back to portfolio</a>
    </div>
  </div>

  <!-- Protected content -->
  <div id="protected-content" hidden>
    <Header />

    <main>
      <section class="section work" id="work">
        <div class="board-grid">
          {privateWork.map((item) => (
            <BoardCard
              title={item.data.title}
              description={item.data.description}
              video={item.data.video}
              poster={item.data.poster}
            />
          ))}
        </div>
      </section>

      <section class="section drawings" id="drawings">
        {projects.map((project) => {
          const items = privateDrawings.filter(d => d.data.project === project);
          const description = items.find(d => d.data.description)?.data.description;
          return (
            <div class="project-drawings">
              <h2 class="heading">{project}</h2>
              {description && <p class="project-description">{description}</p>}
              <div class="gallery-grid">
                {items.map((item) => (
                  <GalleryItem
                    alt={item.data.alt}
                    image={item.data.image}
                    full={item.data.full}
                  />
                ))}
              </div>
            </div>
          );
        })}
      </section>
    </main>

    <Footer />
  </div>

  <script>
    const PASSWORD_HASH = import.meta.env.PUBLIC_PASSWORD_HASH;
    const SESSION_KEY = 'sarrah_private_auth';

    async function hashPassword(password: string): Promise<string> {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function unlock() {
      document.getElementById('password-gate')!.hidden = true;
      document.getElementById('protected-content')!.hidden = false;
    }

    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
      unlock();
    }

    document.getElementById('password-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('password-input') as HTMLInputElement;
      const error = document.getElementById('password-error')!;
      const hash = await hashPassword(input.value);
      if (hash === PASSWORD_HASH) {
        sessionStorage.setItem(SESSION_KEY, 'true');
        unlock();
      } else {
        error.hidden = false;
        input.value = '';
        input.focus();
      }
    });
  </script>
</BaseLayout>
